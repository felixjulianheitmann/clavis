name: publish-windows
description: publish the windows installer
inputs:
  tag:
    type: string  
    description: the tag used for this action
    required: true
  distance:
    type: string
    description: number of additional builds since last tag
    required: true
  versionEncoded:
    type: string
    description: a version in form of "x.x.x.x"
    required: true
  token:
    type: string
    required: true
  

runs:
  using: "composite"
  steps:
  - name: print version
    shell: bash
    run: |
      echo Version: ${{ inputs.tag }}
      echo Distance: ${{ inputs.distance }}

  - name: Download builds
    uses: "actions/download-artifact@v4"
    with:
      name: clavis-windows-amd64-${{ inputs.tag }}-${{ github.sha }}
      path: ${{github.workspace}}/tmp.cicd/builds-windows

  - name: list downloads
    shell: bash
    run: ls '${{github.workspace}}/tmp.cicd/builds-windows'
      
  - name: bundle installer
    shell: bash
    run: ISCC.exe -DversionStrict="${{ inputs.versionEncoded }}" -Dversion="${{ inputs.tag }}-${{ inputs.distance }}" -DbuildDir='${{github.workspace}}/tmp.cicd/builds-windows' -Otarget .\package\win-installer.iss

  - name: Release
    uses: softprops/action-gh-release@v2
    with:
      files: target/*
      draft: ${{ inputs.distance != 0 }}
      latest: ${{ inputs.distance == 0 }}
      generate_release_notes: true
      fail_on_unmatched_files: true
      token: ${{ inputs.token }}